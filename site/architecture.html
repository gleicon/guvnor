<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>architecture - Guvnor Documentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .font-sans { font-family: 'Inter', sans-serif; }
        .sidebar { min-height: calc(100vh - 4rem); }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-screen-2xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <a href="index.html" class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">G</span>
                        </div>
                        <span class="text-lg font-bold text-gray-900">Guvnor Docs</span>
                    </a>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-gray-600 hover:text-blue-600 text-sm font-medium">Home</a>
                    <a href="getting-started.html" class="text-gray-600 hover:text-blue-600 text-sm font-medium">Getting Started</a>
                    <a href="configuration.html" class="text-gray-600 hover:text-blue-600 text-sm font-medium">Config</a>
                    <a href="https://github.com/gleicon/guvnor" class="text-gray-600 hover:text-blue-600 text-sm font-medium">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="flex max-w-screen-2xl mx-auto">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r sidebar hidden lg:block">
            <nav class="p-4 space-y-1">
                <div class="pb-2 mb-2 border-b">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Getting Started</h3>
                </div>
                <a href="getting-started.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Quick Start</a>
                <a href="workflows.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Daily Workflows</a>
                
                <div class="pb-2 mb-2 mt-6 border-b">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Configuration</h3>
                </div>
                <a href="configuration.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Config Reference</a>
                <a href="examples.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Examples</a>
                
                <div class="pb-2 mb-2 mt-6 border-b">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Platform Guides</h3>
                </div>
                <a href="nextjs.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Next.js</a>
                <a href="react.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">React</a>
                <a href="go.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Go</a>
                <a href="rust.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Rust</a>
                <a href="php.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">PHP</a>
                <a href="java.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Java</a>
                
                <div class="pb-2 mb-2 mt-6 border-b">
                    <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Production</h3>
                </div>
                <a href="systemd.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">SystemD Service</a>
                <a href="architecture.html" class="block px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-md">Architecture</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 min-w-0">
            <div class="px-6 py-8">
                <article class="max-w-4xl">
                    <div class="prose prose-lg max-w-none">
                        <h1 id="architecture">Architecture</h1>
                        <p>How Guvnor works internally and the flow of
                        configuration files.</p>
                        <h2 id="system-architecture">System
                        Architecture</h2>
                        <pre><code>┌─────────────────────────────────────────────────────────────────┐
│                        Guvnor Process                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌──────────────────┐                   │
│  │  HTTP Server    │    │  Management API  │                   │
│  │  (8080/8443)    │    │  (REST/IPC)      │                   │
│  └─────────────────┘    └──────────────────┘                   │
│           │                       │                            │
│           ▼                       ▼                            │
│  ┌─────────────────┐    ┌──────────────────┐                   │
│  │ Reverse Proxy   │    │ Process Manager  │                   │
│  │ - Host routing  │    │ - Lifecycle mgmt │                   │
│  │ - TLS termination│   │ - Health checks  │                   │
│  │ - Load balancing│    │ - Restart policy │                   │
│  └─────────────────┘    └──────────────────┘                   │
│           │                       │                            │
│           │              ┌────────┼────────┐                   │
│           │              ▼        ▼        ▼                   │
│           │      ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│           │      │ App A   │ │ App B   │ │ App C   │           │
│           │      │ :3000   │ │ :8000   │ │ :9000   │           │
│           │      └─────────┘ └─────────┘ └─────────┘           │
│           │              │        │        │                   │
│  ┌─────────────────┐     └────────┼────────┘                   │
│  │ TLS Manager     │              │                            │
│  │ - Let&#39;s Encrypt │     ┌────────▼────────┐                   │
│  │ - Auto renewal  │     │ Log Aggregator  │                   │
│  │ - Per-app certs │     │ - Circular buf  │                   │
│  └─────────────────┘     │ - Cross-process │                   │
│           │               └─────────────────┘                   │
└───────────┼─────────────────────────────────────────────────────┘
            │
    ┌───────▼────────┐
    │ Certificate    │
    │ Storage        │
    │ ./certs/       │
    └────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      External Traffic                          │
└─────────────────────────────────────────────────────────────────┘
            │
    ┌───────▼────────┐
    │ HTTP Request   │
    │ Host: api.app  │
    └───────┬────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Guvnor Proxy                                │
├─────────────────────────────────────────────────────────────────┤
│  1. Parse Host header                                           │
│  2. Match to app configuration                                  │
│  3. Apply TLS if configured                                     │
│  4. Forward to app port                                         │
│  5. Return response                                             │
└─────────────────────────────────────────────────────────────────┘</code></pre>
                        <h2 id="configuration-flow">Configuration
                        Flow</h2>
                        <pre><code>┌─────────────────────────────────────────────────────────────────┐
│                    Configuration Lifecycle                     │
└─────────────────────────────────────────────────────────────────┘

1. INITIALIZATION PHASE
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │   Project   │    │ guvnor init │    │ Auto-detect │
   │ Directory   ├───►│   Command   ├───►│    Apps     │
   │             │    │             │    │             │
   └─────────────┘    └─────────────┘    └─────┬───────┘
                                               │
   ┌─────────────┐    ┌─────────────┐         │
   │   Procfile  │    │    .env     │         │
   │ (optional)  │    │ (optional)  │         │
   │             │    │             │         │
   └─────────────┘    └─────────────┘         │
                                               │
                      ┌─────────────┐         │
                      │guvnor.yaml  │◄────────┘
                      │ Generated   │
                      │             │
                      └─────────────┘

2. RUNTIME PHASE
   ┌─────────────┐
   │guvnor start │
   │   Command   │
   └─────┬───────┘
         │
         ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │Load Config  │    │ Validate    │    │   Start     │
   │guvnor.yaml  ├───►│   Apps      ├───►│ Processes   │
   │             │    │             │    │             │
   └─────────────┘    └─────────────┘    └─────┬───────┘
                                               │
   ┌─────────────┐    ┌─────────────┐         │
   │   .env      │    │Environment  │         │
   │Variables    ├───►│Substitution │         │
   │             │    │             │         │
   └─────────────┘    └─────────────┘         │
                                               │
   ┌─────────────┐    ┌─────────────┐         │
   │   Procfile  │    │Process Defs │         │
   │Parsing      ├───►│(if exists)  │         │
   │(fallback)   │    │             │         │
   └─────────────┘    └─────────────┘         │
                                               │
                      ┌─────────────┐         │
                      │   Runtime   │◄────────┘
                      │ Supervision │
                      └─────────────┘

3. MANAGEMENT PHASE
   ┌─────────────┐
   │ CLI Commands│
   │ guvnor logs │
   │ guvnor stop │
   └─────┬───────┘
         │
         ▼
   ┌─────────────┐    ┌─────────────┐
   │Management   │    │   Live      │
   │    API      ├───►│ Process     │
   │             │    │ Control     │
   └─────────────┘    └─────────────┘</code></pre>
                        <h2 id="file-priorities-and-lifecycle">File
                        Priorities and Lifecycle</h2>
                        <pre><code>Configuration Priority (highest to lowest):
┌─────────────────────────────────────────┐
│ 1. guvnor.yaml (explicit config)       │ ← Primary
├─────────────────────────────────────────┤
│ 2. Procfile (process definitions)      │ ← Fallback  
├─────────────────────────────────────────┤
│ 3. Auto-detection (package.json, etc.) │ ← Last resort
└─────────────────────────────────────────┘

Environment Variables:
┌─────────────────────────────────────────┐
│ 1. guvnor.yaml app.environment{}        │ ← Per-app override
├─────────────────────────────────────────┤  
│ 2. .env file variables                  │ ← Global defaults
├─────────────────────────────────────────┤
│ 3. System environment                   │ ← System-wide
└─────────────────────────────────────────┘

File Lifecycle:
┌────────────┬─────────────┬──────────────┬─────────────┐
│    File    │   Created   │    Read      │   Updated   │
├────────────┼─────────────┼──────────────┼─────────────┤
│guvnor.yaml │ guvnor init │ guvnor start │ Manual edit │
│            │             │ guvnor validate │          │
├────────────┼─────────────┼──────────────┼─────────────┤
│ Procfile   │ guvnor init │ guvnor start │ Manual edit │
│            │ (optional)  │ (if no yaml) │             │
├────────────┼─────────────┼──────────────┼─────────────┤
│   .env     │ guvnor init │ guvnor start │ Manual edit │
│            │ (optional)  │ (always)     │             │
├────────────┼─────────────┼──────────────┼─────────────┤
│   logs     │ guvnor start│ guvnor logs  │ Auto-rotate │
└────────────┴─────────────┴──────────────┴─────────────┘</code></pre>
                        <h2 id="process-management">Process
                        Management</h2>
                        <pre><code>┌─────────────────────────────────────────────────────────────────┐
│                     Process Supervision                        │
└─────────────────────────────────────────────────────────────────┘

Application Lifecycle:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   STOPPED   │───►│  STARTING   │───►│   RUNNING   │
│             │    │             │    │             │
└─────────────┘    └─────┬───────┘    └─────┬───────┘
        ▲                │                  │
        │                ▼                  │
        │          ┌─────────────┐          │
        │          │   FAILED    │          │
        │          │             │          │
        │          └─────┬───────┘          │
        │                │                  │
        │                ▼                  │
        │          ┌─────────────┐          │
        └──────────┤ RESTARTING  │◄─────────┘
                   │             │
                   └─────────────┘

Health Check Flow:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│HTTP Request │    │   Success   │    │   Healthy   │
│to /health   ├───►│ (200 OK)    ├───►│    State    │
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
                           │
                           ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Failure   │    │   Retry     │    │  Unhealthy  │
│ (Non-200)   ├───►│ (N times)   ├───►│  -&gt; Restart │
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘</code></pre>
                        <h2 id="virtual-host-routing">Virtual Host
                        Routing</h2>
                        <pre><code>┌─────────────────────────────────────────────────────────────────┐
│                    Request Routing                             │
└─────────────────────────────────────────────────────────────────┘

Incoming Request:
┌─────────────────┐
│ GET /api/users  │
│ Host: api.app   │
│ User-Agent: ... │
└─────┬───────────┘
      │
      ▼
┌─────────────────┐
│ Parse Host      │
│ header          │
│ &quot;api.app&quot;       │
└─────┬───────────┘
      │
      ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Match against   │    │   app: api      │    │ Forward to      │
│ app hostnames   ├───►│ hostname:api.app├───►│ localhost:8000  │
│                 │    │ port: 8000      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                      │
      ┌───────────────────────────────────────────────┘
      ▼
┌─────────────────┐    ┌─────────────────┐
│ App Response    │    │ Return to       │
│ 200 OK          ├───►│ Client          │
│ {...users...}   │    │                 │
└─────────────────┘    └─────────────────┘

Multiple Apps:
web.localhost:8080 ──► App A (port 3000) ──► Frontend
api.localhost:8080 ──► App B (port 8000) ──► API
admin.localhost:8080 ► App C (port 9000) ──► Admin</code></pre>
                        <h2 id="tls-certificate-management">TLS
                        Certificate Management</h2>
                        <pre><code>┌─────────────────────────────────────────────────────────────────┐
│                   TLS Certificate Flow                         │
└─────────────────────────────────────────────────────────────────┘

Per-App TLS Configuration:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   App A     │    │   App B     │    │   App C     │
│ hostname:   │    │ hostname:   │    │ hostname:   │
│ web.com     │    │ api.com     │    │ admin.com   │
│ tls: true   │    │ tls: true   │    │ tls: false  │
└─────┬───────┘    └─────┬───────┘    └─────┬───────┘
      │                  │                  │
      ▼                  ▼                  ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│Let&#39;s Encrypt│    │Let&#39;s Encrypt│    │   HTTP      │
│Certificate  │    │Certificate  │    │   Only      │
│web.com      │    │api.com      │    │             │
└─────────────┘    └─────────────┘    └─────────────┘

Certificate Lifecycle:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Request    │    │   Obtain    │    │   Store     │
│Certificate  ├───►│from LE/ACME ├───►│ in cert_dir │
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────┬───────┘
        ▲                                   │
        │                                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│Auto-renewal │◄───┤   Monitor   │◄───┤    Load     │
│(30 days)    │    │  Expiry     │    │   &amp; Use     │
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘</code></pre>
                        <h2 id="key-components">Key Components</h2>
                        <h3 id="discovery-engine">1. Discovery
                        Engine</h3>
                        <ul>
                        <li>Scans project directory for known
                        application patterns</li>
                        <li>Detects package.json, go.mod, Cargo.toml,
                        requirements.txt</li>
                        <li>Generates appropriate commands and
                        configurations</li>
                        </ul>
                        <h3 id="process-manager">2. Process Manager</h3>
                        <ul>
                        <li>Supervises application processes using Go’s
                        os/exec</li>
                        <li>Implements restart policies with exponential
                        backoff</li>
                        <li>Monitors process health via HTTP/TCP
                        checks</li>
                        <li>Handles graceful shutdown (SIGTERM →
                        SIGKILL)</li>
                        </ul>
                        <h3 id="reverse-proxy">3. Reverse Proxy</h3>
                        <ul>
                        <li>HTTP server with virtual host routing</li>
                        <li>Parses Host headers to route requests</li>
                        <li>Handles TLS termination per-application</li>
                        <li>Implements load balancing for multiple
                        instances</li>
                        </ul>
                        <h3 id="certificate-manager">4. Certificate
                        Manager</h3>
                        <ul>
                        <li>Integrates with Let’s Encrypt ACME
                        protocol</li>
                        <li>Manages per-application certificates</li>
                        <li>Automatic renewal before expiry</li>
                        <li>Stores certificates in configurable
                        directory</li>
                        </ul>
                        <h3 id="configuration-system">5. Configuration
                        System</h3>
                        <ul>
                        <li>YAML-based primary configuration
                        (guvnor.yaml)</li>
                        <li>Procfile fallback for Heroku
                        compatibility</li>
                        <li>Environment variable substitution from .env
                        files</li>
                        <li>Smart defaults with override capability</li>
                        </ul>
                        <h3 id="logging-system">6. Logging System</h3>
                        <ul>
                        <li>Circular buffer for cross-process log
                        aggregation</li>
                        <li>HTTP API for log retrieval by CLI
                        commands</li>
                        <li>Structured logging with configurable
                        levels</li>
                        <li>Process-specific log filtering and
                        display</li>
                        </ul>
                        <p>This architecture provides a single-binary
                        solution that replaces complex infrastructure
                        while maintaining flexibility and
                        production-readiness.</p>
                    </div>
                </article>
            </div>
        </main>

        <!-- Table of Contents (will be generated by JS) -->
        <aside class="w-56 hidden xl:block">
            <div class="sticky top-20 p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-2">On this page</h3>
                <div id="toc" class="text-sm space-y-1">
                    <!-- Generated by JavaScript -->
                </div>
            </div>
        </aside>
    </div>

    <style>
        /* Enhanced prose styles for API-docs look */
        .prose h1 {
            @apply text-3xl font-bold text-gray-900 border-b border-gray-200 pb-3 mb-8;
        }
        .prose h2 {
            @apply text-2xl font-semibold text-gray-900 mt-12 mb-4 scroll-mt-20;
        }
        .prose h3 {
            @apply text-lg font-semibold text-gray-900 mt-8 mb-3 scroll-mt-20;
        }
        .prose h4 {
            @apply text-base font-semibold text-gray-900 mt-6 mb-2;
        }
        
        /* Terminal-style code blocks */
        .prose pre {
            @apply bg-gray-900 rounded-lg p-4 overflow-x-auto border shadow-sm;
            position: relative;
        }
        .prose pre::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 12px;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #ff5f57 0%, #ff5f57 25%, transparent 25%), 
                        radial-gradient(circle, #ffbd2e 0%, #ffbd2e 25%, transparent 25%), 
                        radial-gradient(circle, #28ca42 0%, #28ca42 25%, transparent 25%);
            background-position: 0 0, 20px 0, 40px 0;
            background-size: 20px 12px;
            background-repeat: no-repeat;
        }
        .prose pre code {
            @apply text-green-400 bg-transparent p-0 text-sm font-mono;
            padding-left: 60px;
            display: block;
        }
        
        /* Inline code */
        .prose code:not(pre code) {
            @apply bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm font-mono;
        }
        
        /* Links */
        .prose a {
            @apply text-blue-600 hover:text-blue-700 no-underline font-medium;
        }
        .prose a:hover {
            @apply underline;
        }
        
        /* Lists */
        .prose ul {
            @apply space-y-2;
        }
        .prose ol {
            @apply space-y-2;
        }
        .prose li {
            @apply leading-relaxed;
        }
        
        /* Tables */
        .prose table {
            @apply w-full border-collapse bg-white rounded-lg shadow-sm overflow-hidden;
        }
        .prose th {
            @apply bg-gray-50 border-b border-gray-200 px-4 py-3 text-left font-semibold text-gray-900;
        }
        .prose td {
            @apply border-b border-gray-200 px-4 py-3 text-gray-700;
        }
        .prose tr:last-child td {
            @apply border-b-0;
        }
        
        /* Blockquotes */
        .prose blockquote {
            @apply bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg;
        }
        .prose blockquote p {
            @apply text-blue-800 italic mb-0;
        }
        
        /* API-style sections */
        .prose .api-section {
            @apply border border-gray-200 rounded-lg p-6 my-6 bg-white shadow-sm;
        }
        .prose .api-method {
            @apply inline-block bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-mono uppercase;
        }
        .prose .api-endpoint {
            @apply font-mono text-lg text-gray-900;
        }
        
        /* Command sections */
        .prose .command-section {
            @apply bg-white border border-gray-200 rounded-lg p-6 my-6 shadow-sm;
        }
        .prose .command-title {
            @apply text-lg font-semibold text-gray-900 mb-2;
        }
        .prose .command-description {
            @apply text-gray-600 mb-4;
        }
        
        /* YAML/Config sections */
        .prose .config-section {
            @apply grid md:grid-cols-2 gap-6 my-8;
        }
        .prose .config-example {
            @apply bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm;
        }
        .prose .config-header {
            @apply bg-gray-50 px-4 py-2 border-b border-gray-200;
        }
        .prose .config-content {
            @apply p-0;
        }
    </style>

    <script>
        // Generate table of contents
        document.addEventListener('DOMContentLoaded', function() {
            const toc = document.getElementById('toc');
            const headings = document.querySelectorAll('.prose h2, .prose h3');
            
            if (headings.length === 0 || !toc) return;
            
            headings.forEach((heading, index) => {
                const id = heading.id || `heading-`;
                heading.id = id;
                
                const link = document.createElement('a');
                link.href = `#`;
                link.textContent = heading.textContent;
                link.className = heading.tagName === 'H2' 
                    ? 'block text-gray-700 hover:text-blue-600 py-1' 
                    : 'block text-gray-500 hover:text-blue-600 py-1 ml-3 text-xs';
                
                toc.appendChild(link);
            });
        });
        
        // Copy code block functionality
        document.addEventListener('DOMContentLoaded', function() {
            const codeBlocks = document.querySelectorAll('pre code');
            
            codeBlocks.forEach(code => {
                const pre = code.parentElement;
                const button = document.createElement('button');
                button.textContent = 'Copy';
                button.className = 'absolute top-3 right-3 bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs';
                
                button.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(code.textContent);
                        button.textContent = 'Copied!';
                        setTimeout(() => button.textContent = 'Copy', 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                });
                
                pre.style.position = 'relative';
                pre.appendChild(button);
            });
        });
    </script>
</body>
</html>